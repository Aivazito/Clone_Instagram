<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ß–∞—Ç</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        html { font-family: 'Inter', sans-serif; }
        body { background-color: #f7f9fb; height: 100vh; overflow: hidden; }
        .content-wrapper { height: calc(100vh - 8rem); }
        .profile-card { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
        .active-link { background-color: #f0f4f9; font-weight: 600; }
        .active-link .text-gray-900,
        .active-link .text-gray-500 { color: #1e3a8a !important; }
        .menu-link .fa { color: #6b7280; }
        .menu-link { transition: all 0.2s ease-in-out; margin-bottom: 4px; }
        .menu-link:hover { background-color: #f3f4f6; }
        .allow-badge { background-color: #e5e7eb; color: #4b5563; }
        .custom-input { border: none; background-color: #f8f8f8; transition: background-color 0.2s; }
        .custom-input:focus { background-color: #ffffff; box-shadow: 0 0 0 2px #bfdbfe; outline: none; }
        .chat-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        .chat-scroll { flex-grow: 1; overflow-y: auto; padding-right: 1rem; margin-bottom: 1rem; }
        .message-box { background: #ffffff; border-radius: 1.5rem; line-height: 1.4; max-width: 85%; word-wrap: break-word; padding: 0.75rem 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .outgoing-message-bg { background-color: #e5e7eb; }
        .chat-input-area { background-color: #ffffff; border: 1px solid #e5e7eb; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .chat-scroll::-webkit-scrollbar { width: 6px; }
        .chat-scroll::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 3px; }
    </style>
</head>
<body class="flex justify-center items-start py-16 px-4">
    <div class="flex w-full max-w-5xl gap-8 flex-col lg:flex-row content-wrapper">
        <aside class="w-full lg:w-72 bg-white p-6 rounded-2xl profile-card flex-shrink-0 h-fit">
            <div class="flex items-center pb-6 mb-6 border-b border-gray-100">
                <img id="userAvatar" src="https://placehold.co/56x56/a8c2f5/000000?text=AZ" alt="–ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è" class="w-14 h-14 rounded-full object-cover mr-4 shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/56x56/a8c2f5/000000?text=AZ';" />
                <div class="user-info truncate">
                    <div class="font-semibold text-gray-900 text-base truncate" id="displayUsername">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    <div class="text-sm text-gray-500 truncate"><span id="userEmailDisplay">–∑–∞–≥—Ä—É–∑–∫–∞</span></div>
                </div>
            </div>
            <nav class="space-y-1">
                <a href="user_profile.html" class="menu-link flex items-center p-3 text-gray-900 rounded-xl">
                    <i class="fas fa-user w-5 text-lg text-center mr-3 text-gray-500"></i>
                    <span class="flex-grow">–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</span>
                    <i class="fas fa-chevron-right text-sm text-gray-500 ml-2"></i>
                </a>
                <a href="#" class="menu-link active-link flex items-center p-3 text-gray-900 rounded-xl">
                    <i class="fas fa-users w-5 text-lg text-center mr-3"></i>
                    <span class="flex-grow">–ß–∞—Ç—ã</span>
                    <i class="fas fa-chevron-right text-sm text-gray-500 ml-2"></i>
                </a>
                <a href="#" class="menu-link flex items-center p-3 text-gray-900 rounded-xl">
                    <i class="fas fa-bell w-5 text-lg text-center mr-3 text-gray-500"></i>
                    <span class="flex-grow">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</span>
                    <span class="allow-badge text-xs font-medium px-2 py-1 rounded-md ml-2">Allow</span>
                </a>
                <button id="logoutBtn" class="w-full menu-link flex items-center p-3 text-gray-900 rounded-xl mt-4 group hover:bg-red-50 hover:text-red-600">
                    <i class="fas fa-sign-out-alt w-5 text-lg text-center mr-3 text-gray-500 group-hover:text-red-600"></i>
                    <span class="flex-grow text-left">–í—ã–π—Ç–∏</span>
                </button>
            </nav>
        </aside>

        <main class="flex-grow bg-white p-6 lg:p-8 rounded-2xl profile-card flex flex-col">
            <div class="chat-container">
                <div id="messagesContainer" class="chat-scroll space-y-6">
                    <div class="text-center text-sm text-gray-500 my-4">–°–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div class="mt-6 flex-shrink-0">
                    <div class="chat-input-area flex items-center p-3 rounded-2xl">
                        <input id="messageInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" class="flex-grow p-2 text-gray-700 focus:outline-none bg-transparent" aria-label="–ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è"/>
                        <button class="text-gray-500 hover:text-gray-700 p-2 text-xl transition-colors"><i class="far fa-smile"></i></button>
                        <button class="text-gray-500 hover:text-gray-700 p-2 text-xl transition-colors mx-1"><i class="fas fa-paperclip"></i></button>
                        <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md transition-colors ml-2">
                            <i class="fas fa-paper-plane text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

<script>
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
let CURRENT_USER_DATA = {
    username: "–ó–∞–≥—Ä—É–∑–∫–∞...",
    email: "–∑–∞–≥—Ä—É–∑–∫–∞",
    photoPath: ""
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
async function fetchUserProfile() {
    try {
        const response = await fetch('/user');
        if (response.status === 401) {
            window.location.href = "/login.html"; // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –≤—Ö–æ–¥, –µ—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            return;
        }
        const data = await response.json();
        if (data.status === "success") {
            CURRENT_USER_DATA.username = data.username;
            CURRENT_USER_DATA.email = data.email;
            // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ photo_url –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å
            CURRENT_USER_DATA.photoPath = data.photo_url || "https://placehold.co/56x56/a8c2f5/000000?text=AZ"; 
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
            document.getElementById('displayUsername').textContent = CURRENT_USER_DATA.username;
            document.getElementById('userEmailDisplay').textContent = CURRENT_USER_DATA.email;
            document.getElementById('userAvatar').src = CURRENT_USER_DATA.photoPath;
            
            initChat(); // –ó–∞–ø—É—Å–∫–∞–µ–º —á–∞—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        } else {
            console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", data.message);
        }
    } catch (error) {
        console.error("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è:", error);
    }
}

// –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —á–∞—Ç–∞
function initChat() {
    const messagesContainer = document.getElementById("messagesContainer");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    if (!window.WebSocket) { console.error("WebSocket –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è."); return; }
    const ws = new WebSocket("ws://localhost:8080/ws");

    ws.onopen = () => { 
        console.log("‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ."); 
        messagesContainer.scrollTop = messagesContainer.scrollHeight; 
    };
    
    ws.onmessage = (event) => {
        try {
            const rawMsg = event.data;
            const msg = JSON.parse(rawMsg);
            
            switch (msg.type) {
                case "chat":
                    // –û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–∞—Ç–∞
                    appendMessage(msg);
                    break;
                case "history":
                    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏
                    msg.data.forEach(m => appendMessage(m, true)); // true - –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    break;
                case "user_update":
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    handleUserUpdate(msg);
                    break;
                default:
                    console.warn("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è:", msg.type);
            }
        } catch (e) { 
            console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:", e); 
        }
    };
    
    ws.onerror = (error) => { console.error("‚ùå –û—à–∏–±–∫–∞ WebSocket:", error); };
    ws.onclose = () => { console.log("üîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ."); };

    // --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π ---
    function appendMessage(msg, isHistory = false) {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏—Å—Ö–æ–¥—è—â–∏–º –¥–ª—è –¢–ï–ö–£–©–ï–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const isOutgoing = msg.username === CURRENT_USER_DATA.username;
        const wrapper = document.createElement("div");
        wrapper.className = isOutgoing ? "flex justify-end" : "flex items-start";

        // –ï—Å–ª–∏ photo_url –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
        const avatarUrl = msg.photo_url || "https://placehold.co/56x56/a8c2f5/000000?text=AZ";
        
        const avatarHtml = `<img src="${avatarUrl}" alt="–ê–≤–∞—Ç–∞—Ä" class="w-10 h-10 rounded-full object-cover ${isOutgoing ? 'ml-3' : 'mr-3'} flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/56x56/a8c2f5/000000?text=AZ';"/>`;

        // –ò–º—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
        const senderNameHtml = `<div class="font-semibold text-sm ${isOutgoing ? 'text-right' : 'text-left'} mb-1">${msg.username}</div>`;

        const messageContent = `<div class="flex flex-col ${isOutgoing ? 'items-end' : 'items-start'} max-w-xs sm:max-w-md">
            ${senderNameHtml}
            <div class="message-box ${isOutgoing ? 'outgoing-message-bg rounded-tr-sm' : 'bg-gray-100 rounded-tl-sm'} text-gray-800">${msg.text}</div>
            <div class="text-xs text-gray-500 mt-1 ${isOutgoing ? 'mr-2' : 'ml-2'}">${msg.timestamp}</div>
        </div>`;

        wrapper.innerHTML = isOutgoing ? messageContent + avatarHtml : avatarHtml + messageContent;
        messagesContainer.appendChild(wrapper);
        
        if (!isHistory) {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }

    // --- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
    function sendMessage() {
        const text = messageInput.value.trim();
        if (text && ws.readyState === WebSocket.OPEN) { 
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, —Å–µ—Ä–≤–µ—Ä —Å–∞–º –¥–æ–±–∞–≤–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            const msgToSend = JSON.stringify({ text: text });
            ws.send(msgToSend); 
            messageInput.value = ""; 
        }
    }
    
    // --- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
    function handleUserUpdate(msg) {
        console.log(`–ü—Ä–æ—Ñ–∏–ª—å ${msg.old_email} –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞ ${msg.new_email}`);

        // –ï—Å–ª–∏ —ç—Ç–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Å–∞–µ—Ç—Å—è –¢–ï–ö–£–©–ï–ì–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
        if (msg.old_email === CURRENT_USER_DATA.email || msg.new_email === CURRENT_USER_DATA.email) {
            CURRENT_USER_DATA.username = msg.username;
            CURRENT_USER_DATA.email = msg.new_email;
            CURRENT_USER_DATA.photoPath = msg.photo_url;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            document.getElementById('displayUsername').textContent = CURRENT_USER_DATA.username;
            document.getElementById('userEmailDisplay').textContent = CURRENT_USER_DATA.email;
            document.getElementById('userAvatar').src = CURRENT_USER_DATA.photoPath;
            
            // –û–ø–æ–≤–µ—â–µ–Ω–∏–µ –≤ —á–∞—Ç
            const notification = document.createElement("div");
            notification.className = "text-center text-sm text-blue-500 my-2";
            notification.textContent = `${msg.username} –æ–±–Ω–æ–≤–∏–ª —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å.`;
            messagesContainer.appendChild(notification);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    }


    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", (e) => { 
        if (e.key === 'Enter') { 
            e.preventDefault(); 
            sendMessage(); 
        } 
    });
}

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–∞ ---
document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        const response = await fetch('/logout', { method: 'POST' });
        const data = await response.json();
        if (data.status === 'success') {
            window.location.href = '/login.html';
        } else {
            alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + data.message);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
    }
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å, –ø–æ—Ç–æ–º —á–∞—Ç
document.addEventListener('DOMContentLoaded', fetchUserProfile);

</script>
</body>
</html>
